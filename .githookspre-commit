#!/usr/bin/env bash

# If any command fails, exit immediately with that command's exit status
set -eo pipefail

# Find all changed PHP files for this commit
CHANGED_FILES=$(git diff --name-only --cached --diff-filter=ACMR | grep '\.php$' || true)

# Function to join array elements with a delimiter
function join_by {
  local d=${1-} f=${2-}
  if shift 2; then
    printf %s "$f" "${@/#/$d}"
  fi
}

if [[ -n "$CHANGED_FILES" ]]; then
    echo "Running PHP CS Fixer on changed files..."
    
    # Run PHP CS Fixer on changed files
    ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.dist.php $CHANGED_FILES
    
    # Add the fixed files back to staging area
    git add $CHANGED_FILES
    
    echo "PHP CS Fixer completed and changes staged."
    
    # Run PHP Mess Detector on changed files (comma-separated)
    echo "Running PHPMD on changed files..."
    PHPMD_FILES=$(join_by , $CHANGED_FILES)
    
    ./vendor/bin/phpmd $PHPMD_FILES ansi codesize,unusedcode,naming
    
    if [ $? -eq 0 ]; then
        echo "PHPMD passed!"
    else
        echo "PHPMD found issues. Commit aborted."
        exit 1
    fi
fi

echo "Pre-commit checks passed!"
exit 0